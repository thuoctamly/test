<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trung t√¢m Gi√°m s√°t T√¢m l√Ω (Admin)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* ================================================================= */
        /* 1. CSS G·ªêC T·ª™ INDEX.HTML (ƒê·ªÇ ƒê·∫¢M B·∫¢O GIAO DI·ªÜN GI·ªêNG 100%)      */
        /* ================================================================= */
        :root{ --bg:#f4f7fb; --ruler-bg:#0b63a8; }
        body { font-family: system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; padding:0; background: #f0f2f5; height: 100vh; overflow: hidden; }
        
        /* CSS CHO B·∫¢NG & CARD NH·∫¨T K√ù */
        .cycle-card { background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 24px; overflow: hidden; border: 1px solid #e1e4e8; }
        .card-header { padding: 12px 16px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .log-container { max-height: 220px; overflow-y: auto; border-bottom: 1px solid #eee; background: #ffffff; }
        .log-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .log-table th { position: sticky; top: 0; background: #004080; color: white; padding: 8px; font-weight: 500; text-align: left; }
        .log-table td { padding: 8px; border-bottom: 1px solid #f1f1f1; color: #333; }
        .log-table tr:nth-child(even) { background-color: #fcfcfc; }
        
        /* M√ÄU S·∫ÆC THEO KHUYNH H∆Ø·ªöNG */
        .color-purple .log-table th { background: #8e44ad; }
        .color-purple .card-header strong { color: #8e44ad !important; }
        
        .color-red .log-table th { background: #e74c3c; }
        .color-red .card-header strong { color: #e74c3c !important; }
        
        .color-green .log-table th { background: #2ecc71; }
        .color-green .card-header strong { color: #2ecc71 !important; }
        
        .color-blue .log-table th { background: #2980b9; }
        .color-blue .card-header strong { color: #2980b9 !important; }
        
        .color-amber .log-table th { background: #FFD700; color: #333; }
        .color-amber .card-header strong { color: #FFD700 !important; }

        /* PH·∫¶N HI·ªÇN TH·ªä D·ªÆ LI·ªÜU ƒê√É L∆ØU */
        .feedback-area { padding: 16px; background-color: #fdfdfd; }
        .saved-data { background: #eef9f0; border: 1px solid #c3e6cb; padding: 12px; border-radius: 8px; color: #333; }
        .saved-item { margin-bottom: 8px; font-size: 14px; }
        .saved-label { font-weight: bold; color: #155724; display: block; }
        .emoji-result { font-weight: bold; color: #004080; }

        /* ================================================================= */
        /* 2. CSS RI√äNG CHO LAYOUT ADMIN                                     */
        /* ================================================================= */
        .admin-layout { display: flex; height: 100%; }
        
        /* SIDEBAR (DANH S√ÅCH USER) */
        .sidebar { 
            width: 320px; background: white; border-right: 1px solid #ddd; 
            display: flex; flex-direction: column; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); z-index: 10;
        }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #eee; background: #fafafa; }
        .user-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .user-card {
            padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer;
            border: 1px solid transparent; transition: all 0.2s; background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .user-card:hover { background: #f0f8ff; border-color: #b3e5fc; }
        .user-card.active { background: #e3f2fd; border-left: 4px solid #0d47a1; border-color: #bbdefb; }
        
        .status-badge { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .online { background: #2ecc71; box-shadow: 0 0 6px #2ecc71; }
        .offline { background: #ccc; }

        /* MAIN CONTENT (CHI TI·∫æT NH·∫¨T K√ù) */
        .main-content { flex: 1; overflow-y: auto; padding: 25px; background: #f4f7fb; position: relative; }
        .empty-state {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: #888;
        }
        .profile-header {
            background: #fff; padding: 15px 20px; border-radius: 8px; 
            margin-bottom: 20px; border-left: 5px solid #004080;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Scrollbar ƒë·∫πp */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #999; }
    </style>
</head>
<body>

<div class="admin-layout">
    <div class="sidebar">
        <div class="sidebar-header">
            <h3 style="margin:0; color:#004080;">üõ°Ô∏è Freud Admin</h3>
            <small style="color:#666;">Danh s√°ch ng∆∞·ªùi d√πng (<span id="userCount">0</span>)</small>
        </div>
        <div class="user-list" id="usersContainer">
            <div style="text-align:center; padding:20px; color:#666;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>
    </div>

    <div class="main-content" id="detailContainer">
        <div class="empty-state">
            <h1 style="font-size: 50px; margin-bottom: 10px;">üëà</h1>
            <h3>Ch·ªçn ng∆∞·ªùi d√πng ƒë·ªÉ xem Nh·∫≠t k√Ω</h3>
            <p>D·ªØ li·ªáu hi·ªÉn th·ªã ƒë·ªìng b·ªô 100% v·ªõi giao di·ªán ng∆∞·ªùi d√πng.</p>
        </div>
    </div>
</div>

<script>
    // --- 1. C·∫§U H√åNH FIREBASE (ƒê√É FIX S·∫¥N T·ª™ INDEX.HTML C·ª¶A B·∫†N) ---
    const firebaseConfig = { 
        apiKey : "AIzaSyBvSBloHwRCvWNzt37ThhxuPqVqgQfohlo" , 
        authDomain : "freudruler.firebaseapp.com" , 
        databaseURL : "https://freudruler-default-rtdb.asia-southeast1.firebasedatabase.app" , 
        projectId : "freudruler" , 
        storageBucket : "freudruler.firebasestorage.app" , 
        messagingSenderId : "907969291678" , 
        appId : "1:907969291678:web:e0e99eb6550a31bd42a28f" , 
        measurementId : "G-69JD3RTJQH" 
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // --- 2. C√ÅC H√ÄM TI·ªÜN √çCH (HELPER) T·ª™ INDEX.HTML ---
    function formatDateTime(ts) {
        if (!ts) return { date: '--', time: '--' };
        const d = new Date(ts);
        const date = d.toLocaleDateString('vi-VN');
        const time = d.toLocaleTimeString('vi-VN', { hour12: false });
        return { date, time };
    }

    // Helper: Logic ph√¢n lo·∫°i m√†u s·∫Øc v√† bi·ªÉu t∆∞·ª£ng (Core Logic)
    function getCategoryFromValue(v) {
        const n = Number(v || 0);
        if (n <= -6667) return { key: 'bn_manh', label: 'B·∫£n nƒÉng m·∫°nh', emoji: 'üòà', color: '#8e44ad', cls: 'color-purple' };
        if (n <= -3334) return { key: 'bn_vua',  label: 'B·∫£n nƒÉng v·ª´a',  emoji: 'üî•', color: '#e74c3c', cls: 'color-red' };
        if (n >= 6667)  return { key: 'sn_manh', label: 'Si√™u ng√£ m·∫°nh',  emoji: 'üòá', color: '#FFD700', cls: 'color-amber' };
        if (n >= 3334)  return { key: 'sn_vua',  label: 'Si√™u ng√£ v·ª´a',   emoji: 'üïäÔ∏è', color: '#2980b9', cls: 'color-blue' };
        return { key: 'ego', label: 'B·∫£n ng√£', emoji: 'üë§', color: '#2ecc71', cls: 'color-green' };
    }

    // Helper: Render Sao
    function renderStarStatic(val) {
        let s = "";
        for(let i=1; i<=5; i++) s += (i<=val ? "‚òÖ" : "‚òÜ");
        return `<span style="color:#f1c40f; font-size:16px;">${s}</span> <small>(${val}/5)</small>`;
    }

    // Helper: Render Emoji
    const EMOJI_SCALE = ['üò°', '‚òπÔ∏è', 'üòê', 'üôÇ', 'üòç'];
    const EMOJI_LABELS = ['R·∫•t kh√¥ng h√†i l√≤ng', 'Kh√¥ng h√†i l√≤ng', 'B√¨nh th∆∞·ªùng', 'H√†i l√≤ng', 'R·∫•t h√†i l√≤ng'];
    function renderEmojiResult(val) {
        if (!val || val < 1) return "Ch∆∞a ƒë√°nh gi√°";
        const icon = EMOJI_SCALE[val - 1];
        const text = EMOJI_LABELS[val - 1];
        return `<span class="emoji-result">${icon} ${text}</span>`;
    }

    // --- 3. LOGIC HI·ªÇN TH·ªä DANH S√ÅCH USER ---
    const usersContainer = document.getElementById('usersContainer');
    const userCountEl = document.getElementById('userCount');

    // L·∫Øng nghe d·ªØ li·ªáu
    db.ref('users').on('value', (snapshot) => {
        const users = snapshot.val();
        renderSidebar(users);
    }, (error) => {
        console.error("L·ªói Firebase:", error);
        usersContainer.innerHTML = `<div style="color:red; text-align:center; padding:20px;">
            L·ªói quy·ªÅn truy c·∫≠p!<br>H√£y ki·ªÉm tra l·∫°i Rules tr√™n Firebase Console.
        </div>`;
    });

    function renderSidebar(users) {
        if (!users) {
            usersContainer.innerHTML = '<div style="text-align:center; padding:20px;">Ch∆∞a c√≥ d·ªØ li·ªáu n√†o.</div>';
            userCountEl.innerText = '0';
            return;
        }

        let html = '';
        let count = 0;
        
        // S·∫Øp x·∫øp: Online l√™n ƒë·∫ßu
        const sortedKeys = Object.keys(users).sort((a,b) => {
            const statA = (users[a].currentStatus === 'online') ? 1 : 0;
            const statB = (users[b].currentStatus === 'online') ? 1 : 0;
            return statB - statA;
        });

        sortedKeys.forEach(userId => {
            const u = users[userId];
            const profile = u.profile || {};
            const isOnline = u.currentStatus === 'online';
            const lastActive = u.lastActive ? formatDateTime(u.lastActive).time + ' ' + formatDateTime(u.lastActive).date : '--';
            count++;

            html += `
                <div class="user-card" onclick="loadUserDetail('${userId}')" id="card-${userId}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <strong style="color:#333; font-size:15px;">${profile.fullName || userId}</strong>
                        <span class="status-badge ${isOnline ? 'online' : 'offline'}"></span>
                    </div>
                    <div style="font-size:12px; color:#666; margin: 4px 0;">
                        L·ªõp: <b>${profile.className || '--'}</b> | NS: ${profile.birthYear || '--'}
                    </div>
                    <div style="font-size:11px; color:#888;">
                        ${isOnline ? '<b style="color:#2ecc71">ƒêang Online</b>' : 'Ho·∫°t ƒë·ªông cu·ªëi: ' + lastActive}
                    </div>
                </div>
            `;
        });
        
        usersContainer.innerHTML = html;
        userCountEl.innerText = count;
    }

    // --- 4. LOGIC HI·ªÇN TH·ªä CHI TI·∫æT (ƒê·ªíNG B·ªò 100%) ---
    window.loadUserDetail = function(userId) {
        // Highlight active
        document.querySelectorAll('.user-card').forEach(c => c.classList.remove('active'));
        const card = document.getElementById(`card-${userId}`);
        if(card) card.classList.add('active');

        // Fetch data
        db.ref('users/' + userId).once('value').then(snap => {
            const data = snap.val();
            renderMainContent(data);
        });
    };

    function renderMainContent(data) {
        const container = document.getElementById('detailContainer');
        
        if (!data) { container.innerHTML = "Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu."; return; }

        const profile = data.profile || {};
        const history = data.history || [];

        let html = `
            <div class="profile-header">
                <div>
                    <h2 style="margin:0; color:#004080;">${profile.fullName || 'Kh√¥ng t√™n'}</h2>
                    <span style="color:#666; font-size:14px;">L·ªõp: ${profile.className} | NƒÉm sinh: ${profile.birthYear}</span>
                </div>
                <div style="text-align:right;">
                     <div style="font-size:12px; color:#888;">T·ªïng s·ªë chu k·ª≥ ho√†n th√†nh</div>
                     <div style="font-size:24px; font-weight:bold; color:#004080;">${history.length}</div>
                </div>
            </div>
        `;

        if (history.length === 0) {
            html += `<div style="text-align:center; padding: 40px; color:#666; background:#fff; border-radius:12px;">
                        <h3>üì≠ Ng∆∞·ªùi d√πng n√†y ch∆∞a ho√†n th√†nh chu k·ª≥ n√†o.</h3>
                     </div>`;
            container.innerHTML = html;
            return;
        }

        // --- A. B·∫¢NG T·ªîNG K·∫æT (SUMMARY TABLE) ---
        html += `
            <h4 style="color:#4a148c; margin:0 0 10px 0; font-size: 16px; font-weight: 700; text-transform: uppercase; border-left: 4px solid #7b1fa2; padding-left: 10px;">üìì T·ªîNG K·∫æT L·ªäCH S·ª¨</h4>
            <div style="overflow-x:auto; box-shadow: 0 4px 10px rgba(0,0,0,0.05); background: #ffffff; border: 1px solid #e1bee7; margin-bottom: 25px; border-radius: 8px;">
            <table style="width:100%; min-width:600px; border-collapse:collapse; font-family: sans-serif;">
                <thead>
                    <tr style="background: linear-gradient(135deg, #4a148c 0%, #7b1fa2 100%); color:#ffffff;">
                        <th style="padding:12px; text-align:center;">Chu k·ª≥</th>
                        <th style="padding:12px; text-align:center;">ƒêi·ªÉm TB</th>
                        <th style="padding:12px; text-align:center;">Khuynh h∆∞·ªõng</th>
                        <th style="padding:12px; text-align:center;">T·ªïng ƒëi·ªÉm</th>
                        <th style="padding:12px; text-align:center;">S·ªë l·∫ßn g·∫°t</th>
                        <th style="padding:12px; text-align:center;">Th·ªùi gian</th>
                    </tr>
                </thead>
                <tbody>
        `;

        const tableRows = history.map((cycle, realIndex) => {
            const cycleNum = history.length - realIndex;
            const avgScore = cycle.avgScore;
            const totalScore = cycle.totalScore || (cycle.entries ? cycle.entries.reduce((a,b)=>a+(Number(b.value)||0),0) : 0);
            const startObj = formatDateTime(cycle.startTime);
            const info = getCategoryFromValue(avgScore);

            return `
                <tr style="background-color:${cycleNum % 2 === 0 ? '#f9f9f9' : '#ffffff'}; border-bottom:1px solid #eee;">
                    <td style="padding:8px; text-align:center; font-weight:bold;">${cycleNum}</td>
                    <td style="padding:8px; text-align:center; font-weight:bold; color:${info.color};">
                        ${avgScore > 0 ? '+' : ''}${avgScore.toFixed(1)}
                    </td>
                    <td style="padding:8px; text-align:center; font-weight: bold; color:${info.color};">
                        ${info.emoji} ${info.label}
                    </td>
                    <td style="padding:8px; text-align:center;">${totalScore > 0 ? '+' : ''}${totalScore}</td>
                    <td style="padding:8px; text-align:center;">${cycle.entries ? cycle.entries.length : 0}</td>
                    <td style="padding:8px; text-align:center; font-size:12px;">${startObj.time} ${startObj.date}</td>
                </tr>
            `;
        });
        html += tableRows.reverse().join('');
        html += `</tbody></table></div>`;

        // --- B. DANH S√ÅCH TH·∫∫ CHI TI·∫æT ---
        const cardHtmlList = history.map((cycle, realIndex) => {
            const cycleNum = history.length - realIndex;
            const startObj = formatDateTime(cycle.startTime);
            const fb = cycle.feedback || {};
            const info = getCategoryFromValue(cycle.avgScore);

            let card = `<div class="cycle-card ${info.cls}">`;
            
            // Header
            card += `<div class="card-header">
                <div class="header-left">
                    <strong>Chu k·ª≥ ${cycleNum}</strong> <span style="font-size:13px; color:#555;"><span class="neutral-text">(t·ª´ ${startObj.time} ${startObj.date})</span></span>
                </div>
                <div class="header-right" style="font-weight:bold; font-size:15px; color:${info.color}">
                    ${info
